import { Bitmap } from '../model';
import { isCanvasNode } from '../utils/nodeType';
import { errorBase64Url } from '../utils/image';

/**
 * 将Canvas 解析为图片
 * @param canvas
 */
export const parseCanvasToBitmap = (canvas: HTMLCanvasElement) => {
  if (!isCanvasNode(canvas)) return;
  const { width, height, y, x } = canvas.getBoundingClientRect();
  let url;
  try {
    url = canvas.toDataURL();
  } catch (e) {
    const errMsg = e.toString();

    // 存在跨域问题
    if (errMsg.includes('Tainted canvases may not be exported.')) {
      // 跨域问题的显示图片
      url =
        'data:image/png;base64,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';
    } else url = errorBase64Url;
  }

  const bitmap = new Bitmap({ url, width, height, y, x });
  bitmap.mapBasicInfo(canvas);

  return bitmap;
};
